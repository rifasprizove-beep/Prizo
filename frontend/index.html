<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#E0166B" />
  <title>PRIZO</title>

  <!-- CSS + cache-busting -->
  <link rel="stylesheet" href="/style.css?v=20251019a" />

  <!-- Supabase (fallback para subida de comprobantes) -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Inyecta la URL del backend para el front est√°tico -->
  <script src="/config.js"></script>

  <!-- App JS (m√≥dulo) + cache-busting -->
  <script type="module" defer src="/js/main.js?v=20251019a"></script>
</head>
<body>
  <!-- === Overlay de carga (nuevo) === -->
  <div id="appLoading" class="app-loading hidden" role="status" aria-live="polite" aria-busy="true">
    <div class="spinner"></div>
    <div id="appLoadingMsg" class="loading-msg">Cargando‚Ä¶</div>
  </div>

  <!-- T√©rminos -->
  <div id="termsModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="termsTitle">
    <div class="modal-card">
      <div class="modal-header"><h3 id="termsTitle">T√©rminos y Condiciones</h3></div>
      <div class="modal-body">
        <ol>
          <li>Tickets enviados en 24‚Äì48 h tras verificar el pago.</li>
          <li>Mayores de 18 a√±os. Premios en persona.</li>
        </ol>
        <label class="check"><input type="checkbox" id="chkAccept" />Acepto los t√©rminos.</label>
      </div>
      <div class="modal-footer">
        <button id="btnDecline" class="btn-secondary" type="button">Cancelar</button>
        <button id="btnAccept" class="btn-primary" type="button" disabled>Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Cantidad (modal grande opcional) -->
  <div id="qtyModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="qtyTitle">
    <div class="modal-card">
      <div class="modal-header"><h3 id="qtyTitle">¬øCu√°ntos tickets quieres?</h3></div>
      <div class="modal-body">
        <div class="qty-giant" style="justify-content:center">
          <button class="giant-btn" type="button" data-qty-step="-1" aria-label="Restar 1">‚àí</button>
          <input id="qtyModalInput" class="giant-input" type="number" min="1" value="1" inputmode="numeric" aria-label="Cantidad de tickets" />
          <button class="giant-btn" type="button" data-qty-step="1" aria-label="Sumar 1">+</button>
        </div>
        <div class="quick-steps" aria-label="Accesos r√°pidos de cantidad">
          <button class="quick" type="button" data-qty-step="2">+2</button>
          <button class="quick" type="button" data-qty-step="5">+5</button>
          <button class="quick" type="button" data-qty-step="10">+10</button>
        </div>
        <p class="muted center">Adjuntar√°s el comprobante en el siguiente paso.</p>
      </div>
      <div class="modal-footer">
        <button id="qtyCancel" class="btn-secondary" type="button">Cancelar</button>
        <button id="qtyConfirm" class="btn-primary" type="button">Continuar</button>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="site-header">
    <div class="brand">
      <a class="brand-link" href="/" aria-label="Ir al inicio" rel="noopener">
        <img class="brand-logo" src="https://res.cloudinary.com/dzaokhfcw/image/upload/v1760221952/Prizo_jdgk6m.png" alt="PRIZO" />
        <span class="brand-name">PRIZO</span>
      </a>
    </div>
  </header>

  <main class="container">
    <h1 id="homeTitle" class="outside-title">
      RIFAS TRANSPARENTES EN VENEZUELA<br><span class="subtitle">SORTEOS F√ÅCILES Y SEGUROS</span>
    </h1>

    <!-- LISTA -->
    <section id="raffleList" class="card" aria-labelledby="homeTitle">
      <h2>Rifas disponibles</h2>
      <p id="rafflesError" class="muted" style="display:none">‚ö†Ô∏è No se pudieron cargar las rifas.</p>
      <p id="noRaffles" class="muted" style="display:none">No hay rifas abiertas en este momento.</p>
      <div id="rafflesGrid" class="raffles-grid" role="list"></div>
      <div id="rafflesSkeleton" class="skeleton-grid" aria-hidden="true" style="display:none">
        <div class="s-card"></div><div class="s-card"></div><div class="s-card"></div>
      </div>
    </section>

    <!-- DETALLE -->
    <section id="raffleHeader" class="card hidden" aria-live="polite">
      <button class="back" id="backToList" type="button">‚Üê Cambiar de rifa</button>
      <h2 id="raffleName">Rifa</h2>

      <div id="raffleCover" class="cover-wrap hidden" aria-hidden="true">
        <img id="raffleCoverImg" class="cover" alt="Portada de la rifa" loading="lazy" />
      </div>

      <div class="muted" id="raffleMeta"></div>

      <div id="progressWrap" class="progress-wrap hidden" aria-live="polite">
        <div class="progress-top"><span>Avance del sorteo</span><b id="progressPct">0%</b></div>
        <div class="progress-bar" aria-label="Porcentaje vendido">
          <div id="progressFill" class="progress-fill" style="width:0%"><span id="progressFillLabel">0%</span></div>
        </div>
      </div>

      <nav id="raffleNav" class="raffle-nav" aria-label="Navegaci√≥n rifa" style="display:none">
        <div class="nav-track">
          <div class="nav-indicator" aria-hidden="true"></div>
          <button class="nav-btn active" data-target="buy" type="button"><span class="nav-label">Comprar</span></button>
          <button class="nav-btn" data-target="verify" type="button"><span class="nav-label">Verificar</span></button>
          <button class="nav-btn" data-target="draw" type="button"><span class="nav-label">Sorteo</span></button>
        </div>
      </nav>
    </section>

    <!-- PANE: COMPRAR -->
    <section id="sec-buy" class="card section hidden" aria-labelledby="buyTitle">
      <!-- Embedded pop-menu SOLO CANTIDAD (reserva por 10 min) -->
      <div class="embedded-modal" id="embeddedQty" role="dialog" aria-modal="true" aria-labelledby="embeddedQtyTitle" style="display:none">
        <div class="embedded-card">
          <div class="embedded-header"><h3 id="embeddedQtyTitle">¬øCu√°ntos tickets quieres?</h3></div>
          <div class="embedded-body">
            <div class="qty-giant" style="justify-content:center">
              <button class="giant-btn" type="button" data-emb-step="-1" aria-label="Restar 1">‚àí</button>
              <input id="embeddedQtyInput" class="giant-input" type="number" min="1" value="1" inputmode="numeric" aria-label="Cantidad de tickets" />
              <button class="giant-btn" type="button" data-emb-step="1" aria-label="Sumar 1">+</button>
            </div>
            <div class="quick-steps" aria-label="Accesos r√°pidos de cantidad">
              <button class="quick" type="button" data-emb-step="2">+2</button>
              <button class="quick" type="button" data-emb-step="5">+5</button>
              <button class="quick" type="button" data-emb-step="10">+10</button>
            </div>
            <p class="muted center">
              Al continuar, reservaremos tus tickets por <b>10 minutos</b>.
              En el siguiente paso ingresar√°s <b>tus datos y el comprobante</b>.
            </p>
          </div>
          <div class="embedded-footer">
            <button id="embeddedCancel" class="btn-secondary" type="button">Cerrar</button>
            <button id="embeddedContinue" class="btn-primary" type="button">Continuar</button>
          </div>
        </div>
      </div>

      <!-- Encabezado de compra: AHORA oculto hasta pulsar Continuar -->
      <div id="buyHead" class="section-head" style="display:none">
        <button class="back" data-back type="button" style="display:none">‚Üê Volver</button>
        <h2 id="buyTitle">Comprar ticket</h2>
      </div>

      <div class="purchase-summary" id="summaryBox" style="display:none">
        <div class="label">Cantidad seleccionada</div>
        <div class="qty-pill">üéüÔ∏è <span id="qtySummary">‚Äî</span></div>
      </div>

      <div id="paymentArea" class="hidden">
        <div id="methodBox" class="method-box" aria-live="polite">
          <div class="method-head">
            <h4 id="methodTitle">Pago M√≥vil</h4>

            <!-- Controles de la reserva: contador + cancelar -->
            <div class="method-controls">
              <div id="paymentTimer" class="countdown hidden" aria-live="polite">
                Tiempo restante: <b id="paymentTimerValue">10:00</b>
              </div>
              <button id="cancelPaymentBtn" class="btn-ghost" type="button" title="Cancelar y liberar reserva">
                Cancelar reserva
              </button>
            </div>

            <span id="methodStatus" class="badge" style="display:none">‚ö†Ô∏è No configurado</span>
          </div>

          <div id="methodItems" class="method-items"></div>
          <p class="muted-small" id="methodHint">Realiza el pago exacto en Bs. Adjunta el comprobante e indica la referencia.</p>
        </div>

        <div class="notice" id="methodNotice">El monto se calcula en <b>Bol√≠vares</b> a la tasa del d√≠a.</div>
        <p id="pmInfo" class="muted">Cargando datos‚Ä¶</p>

        <!-- ====== CAMPOS DEL COMPRADOR + PAGO ====== -->
        <div class="grid">
          <label>Email
            <input id="email" type="email" placeholder="tu@correo.com" autocomplete="email" />
          </label>

          <label>C√©dula / RIF
            <input id="docId" type="text" placeholder="V-00.000.000" autocomplete="off" />
          </label>

          <label>Estado
            <select id="state">
              <option value="">Selecciona tu estado</option>
              <option>Distrito Capital</option>
              <option>Miranda</option>
              <option>Zulia</option>
              <option>Carabobo</option>
              <option>Aragua</option>
              <option>Nueva Esparta</option>
              <option>Anzo√°tegui</option>
              <option>Monagas</option>
              <option>Lara</option>
              <option>Falc√≥n</option>
              <option>T√°chira</option>
              <option>Trujillo</option>
              <option>Yaracuy</option>
              <option>Portuguesa</option>
              <option>Barinas</option>
              <option>Gu√°rico</option>
              <option>Cojedes</option>
              <option>Apure</option>
              <option>Sucre</option>
              <option>Bol√≠var</option>
              <option>M√©rida</option>
              <option>Delta Amacuro</option>
              <option>Vargas / La Guaira</option>
              <option>Amazonas</option>
              <option>Otro</option>
            </select>
          </label>

          <label>Tel√©fono
            <input id="phone" type="tel" placeholder="0412-1234567" autocomplete="tel" />
          </label>

          <label>Total (Bs)
            <input id="ves" type="text" disabled />
          </label>

          <label class="input-affix">Referencia
            <input id="reference" type="text" placeholder="Ej: 123456 o memo" />
            <button id="pasteRef" class="affix-btn" type="button" title="Pegar">Pegar</button>
          </label>

          <label>Comprobante (foto)
            <input id="evidence" type="file" accept="image/*" />
          </label>
        </div>
        <!-- ====== /CAMPOS ====== -->

        <button id="payBtn" class="btn-primary full" type="button">Enviar pago</button>
        <p id="buyMsg" class="muted" aria-live="polite"></p>
        <small class="muted">‚è≥ Verificaci√≥n 24‚Äì48h. Te enviaremos un correo.</small>
      </div>
    </section>

    <!-- PANE: VERIFICAR -->
    <section id="sec-verify" class="card section hidden" aria-labelledby="verifyTitle">
      <div class="section-head"><button class="back" data-back type="button" style="display:none">‚Üê Volver</button><h2 id="verifyTitle">Verificar ticket / pago</h2></div>
      <div class="grid">
        <label>N¬∫ Ticket <input id="chk_ticket" type="number" placeholder="Opcional" /></label>
        <label>Referencia <input id="chk_ref" type="text" placeholder="Opcional" /></label>
        <label>Email <input id="chk_email" type="email" placeholder="Opcional" /></label>
      </div>
      <button id="checkBtn" class="btn-secondary full" type="button">Consultar</button>
      <pre id="checkOut" class="muted prewrap"></pre>
    </section>

    <!-- PANE: SORTEO -->
    <h1 id="drawTitle" class="outside-title hidden">SORTEO Y GANADOR</h1>
    <section id="sec-draw" class="card section hidden" aria-labelledby="drawTitle">
      <div class="section-head"><button class="back" data-back type="button" style="display:none">‚Üê Volver</button></div>
      <div class="upload-area">
        <input id="csvFile" type="file" accept=".csv" hidden />
        <button id="uploadBtn" class="btn-secondary" type="button">Subir CSV</button>
        <span id="fileName">Suba su archivo CSV</span>
      </div>
      <div class="select-wrap"><select id="columnSelect" disabled><option value="">Selecciona una columna</option></select></div>
      <div class="bombo" id="bombo" aria-live="polite"></div>
      <div id="live" class="muted center"></div>
      <div class="draw-actions"><button id="drawToggle" class="btn-primary" type="button" aria-pressed="false">Iniciar sorteo</button></div>
      <ol id="winners"></ol>
    </section>
  </main>

  <!-- Enlace del bot√≥n "Cancelar reserva" a la funci√≥n global expuesta por main.js -->
  <script>
    (function () {
      const btn = document.getElementById("cancelPaymentBtn");
      if (!btn) return;
      btn.addEventListener("click", () => {
        if (typeof window.prizoCancel === "function") {
          window.prizoCancel("Operaci√≥n cancelada por el usuario.");
        } else {
          const msg = document.getElementById("buyMsg");
          if (msg) {
            msg.textContent = "‚ùå Operaci√≥n cancelada por el usuario.";
            msg.style.color = "#ffd6dd";
          }
        }
      });
    })();
  </script>
</body>
</html>
